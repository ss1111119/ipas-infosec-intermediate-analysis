<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>題組 2：資安事件與防禦框架 (Q15-18)</title>
    
    <!-- 外部資源：Bootstrap 5, FontAwesome, Google Fonts -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" xintegrity="sha384-9ndCyUaIbzAi2FUVXJi0CjmCapSmO7SnpJef0486qhLnuZ2cdeRhO02iuK6FUUVM" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" xintegrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary-color: #2980b9;
            --success-color: #2e7d32;
            --success-bg: #e8f5e9;
            --error-color: #c62828;
            --error-bg: #fce4ec;
            --highlight-color: #f1c40f;
            --text-main: #333333;
            --bg-hover: #e3f2fd;
            --bg-selected: #bbdefb;
            
            /* Tag Colors */
            --tag-law: #607d8b;
            --tag-iso: #27ae60;
            --tag-zt: #8e44ad;
            --tag-net: #2980b9;
            --tag-sec: #c0392b;
            --tag-mgm: #d35400;
        }

        body {
            font-family: "Noto Sans TC", system-ui, -apple-system, sans-serif;
            font-size: 16px;
            background-color: #f4f6f8;
            color: var(--text-main);
            line-height: 1.6;
        }

        /* --- 版型規範 --- */
        .page-container {
            margin: 40px auto;
            padding: 40px;
            background-color: #ffffff;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            border-radius: 16px;
            max-width: 960px;
            width: 100%;
        }

        @media (max-width: 767.98px) {
            .page-container {
                max-width: 100%;
                width: 100%;
                margin: 16px;
                padding: 20px;
                border-radius: 12px;
            }
            h2 { font-size: 20px; }
            h3 { font-size: 18px; }
        }

        h2 { font-size: 24px; font-weight: 700; color: var(--primary-color); margin-bottom: 24px; }
        h3 { font-size: 18px; font-weight: 700; margin-bottom: 16px; border-left: 4px solid var(--primary-color); padding-left: 12px; }

        /* --- Header --- */
        .quiz-header {
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eee;
        }
        
        .progress {
            height: 10px;
            background-color: #e9ecef;
            border-radius: 5px;
            margin-top: 10px;
        }
        
        .progress-bar {
            background-color: var(--success-color);
            transition: width 0.5s ease;
        }

        /* --- Global Context --- */
        .global-context {
            background-color: #fff8e1;
            border: 1px solid #ffe082;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 30px;
            position: relative;
        }
        .global-context::before {
            content: '\f0eb';
            font-family: "Font Awesome 6 Free";
            font-weight: 900;
            position: absolute;
            top: -12px;
            left: 20px;
            background: #fff;
            padding: 0 10px;
            color: var(--highlight-color);
            font-size: 20px;
        }

        /* --- Tabs --- */
        .nav-tabs {
            border-bottom: 2px solid #dee2e6;
            margin-bottom: 24px;
            gap: 4px;
        }
        
        .nav-link {
            color: #666;
            font-weight: 500;
            border: none;
            border-radius: 8px 8px 0 0;
            padding: 12px 20px;
            height: 48px;
            transition: all 200ms ease;
        }
        .nav-link:hover { background-color: #f8f9fa; transform: translateY(-2px); }
        .nav-link.active { color: var(--primary-color); background-color: #fff; border: 2px solid #dee2e6; border-bottom-color: #fff; font-weight: 700; }

        .tab-status-icon { margin-left: 8px; font-size: 14px; }
        .status-correct { color: var(--success-color); }
        .status-wrong { color: var(--error-color); }

        /* --- Question --- */
        .question-text { font-size: 18px; font-weight: 500; margin-bottom: 24px; }
        .negative-keyword { color: var(--error-color); font-weight: 700; text-decoration: underline; }

        /* --- Options --- */
        .option-card {
            display: flex; align-items: flex-start; padding: 16px; margin-bottom: 12px;
            border: 2px solid #e9ecef; border-radius: 10px; cursor: pointer; transition: all 200ms ease;
        }
        .option-card:hover:not(.disabled) { background-color: var(--bg-hover); transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.05); }
        .option-card.selected { background-color: var(--bg-selected); border-color: var(--primary-color); }
        .option-card.correct-answer { background-color: var(--success-bg); border-color: var(--success-color); }
        .option-card.wrong-answer { background-color: var(--error-bg); border-color: var(--error-color); }
        .option-card.disabled { cursor: default; opacity: 0.8; }
        
        .option-indicator {
            min-width: 28px; height: 28px; border-radius: 50%; border: 2px solid #adb5bd;
            margin-right: 12px; display: flex; align-items: center; justify-content: center;
            font-size: 14px; font-weight: bold; color: #adb5bd; flex-shrink: 0;
        }
        .option-card.selected .option-indicator { border-color: var(--primary-color); background-color: var(--primary-color); color: #fff; }
        .type-multi .option-indicator { border-radius: 4px; }
        .option-text { word-break: break-word; flex-grow: 1; }

        /* --- Action Area --- */
        .action-area { margin-top: 24px; display: flex; gap: 12px; }
        .btn-submit { background-color: var(--primary-color); color: white; border: none; padding: 10px 24px; border-radius: 8px; font-weight: 600; min-height: 44px; }
        .btn-submit:hover { background-color: #1f618d; }
        .btn-submit:disabled { background-color: #bdc3c7; cursor: not-allowed; }
        .btn-retry { background-color: white; color: var(--text-main); border: 2px solid #dee2e6; padding: 10px 24px; border-radius: 8px; font-weight: 600; min-height: 44px; display: none; }
        .btn-retry:hover { background-color: #f8f9fa; border-color: #adb5bd; }

        /* --- Feedback & Explain --- */
        .feedback-area {
            margin-top: 20px; padding: 16px; border-radius: 8px; display: none; animation: fadeInUp 300ms ease;
        }
        .feedback-success { background-color: var(--success-bg); border-left: 5px solid var(--success-color); }
        .feedback-error { background-color: var(--error-bg); border-left: 5px solid var(--error-color); }

        /* --- Detailed Analysis Sections --- */
        .explain-container { margin-top: 30px; border-top: 2px dashed #dee2e6; padding-top: 20px; display: none; }
        
        .analysis-step {
            margin-bottom: 24px;
            background: #fff;
            border-radius: 8px;
        }
        .analysis-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            border-bottom: 2px solid #f0f2f5;
            padding-bottom: 8px;
        }
        .analysis-title i { margin-right: 10px; color: var(--primary-color); }
        .analysis-content { padding-left: 8px; color: #444; }

        /* Specific styles for steps */
        .keyword-box span {
            display: inline-block;
            background: #e3f2fd;
            color: #1565c0;
            padding: 4px 10px;
            border-radius: 16px;
            margin-right: 8px;
            margin-bottom: 8px;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .translate-box {
            background-color: #f8f9fa;
            border-left: 4px solid #607d8b;
            padding: 12px;
            font-style: italic;
            color: #555;
        }

        .logic-step { margin-bottom: 8px; position: relative; padding-left: 20px; }
        .logic-step::before {
            content: "•"; color: var(--primary-color); font-weight: bold; position: absolute; left: 0;
        }
        .logic-example {
            background-color: #e8f5e9;
            padding: 10px;
            border-radius: 6px;
            margin-top: 8px;
            font-size: 0.95rem;
            color: #2e7d32;
        }

        .golden-box {
            background: linear-gradient(135deg, #fff9c4 0%, #fff59d 100%);
            border: 2px solid #fbc02d;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            font-weight: bold;
            font-size: 1.1rem;
            color: #f57f17;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }

        .trap-box {
            background-color: #ffebee;
            border: 1px solid #ffcdd2;
            border-radius: 8px;
            padding: 15px;
        }
        .trap-item { margin-bottom: 8px; }
        .trap-label { font-weight: bold; color: #c62828; margin-right: 5px; }

        .self-check {
            background-color: #fff;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            overflow: hidden;
            margin-top: 20px;
        }
        .self-check summary {
            padding: 16px;
            cursor: pointer;
            font-weight: 700;
            background-color: #f8f9fa;
            list-style: none;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .self-check summary::after {
            content: '查看答案';
            font-size: 0.85rem;
            color: #666;
            background: #e9ecef;
            padding: 4px 10px;
            border-radius: 4px;
        }
        .self-check[open] summary::after { content: '收起答案'; }
        .self-check-content { 
            padding: 20px; 
            border-top: 1px solid #dee2e6;
            background-color: #fff;
        }
        
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .tag-badge {
            display: inline-block; padding: 4px 8px; border-radius: 4px;
            color: white; font-size: 12px; font-weight: bold; margin-right: 8px; margin-bottom: 8px;
        }
    </style>
</head>
<body>

<div class="page-container">
    <!-- Header -->
    <div class="quiz-header">
        <div class="d-flex justify-content-between align-items-center mb-2">
            <h2 class="mb-0">題組 2：資安事件與防禦框架</h2>
            <span class="badge bg-secondary" id="progressText">已完成 0/4</span>
        </div>
        <div class="progress">
            <div class="progress-bar" id="progressBar" role="progressbar" style="width: 0%"></div>
        </div>
    </div>

    <!-- Global Context -->
    <div class="global-context">
        <h5 class="fw-bold mb-2"><i class="fas fa-info-circle me-2"></i>題組情境描述</h5>
        <p class="mb-0">
            你在一間上市櫃公司上班，上個月公司突然遭到重大資安事件。起因是有同仁點擊釣魚信件，該釣魚信件並未被郵件閘道伺服器（Mail Gateway）攔截，同時筆電的防毒軟體也沒有更新，導致該筆電被攻擊者控制。後來該台筆電成為攻擊者的跳板，並且攻擊者持續在內部進行橫向移動，最後取得核心系統跟機敏資料的控制權。事件發生後，主管請你制訂後續的改善計畫。
        </p>
    </div>

    <!-- Tabs Navigation -->
    <ul class="nav nav-tabs" id="quizTabs" role="tablist">
        <!-- JS generates tabs here -->
    </ul>

    <!-- Tab Content -->
    <div class="tab-content" id="quizTabContent">
        <!-- JS generates questions here -->
    </div>
</div>

<!-- JavaScript Logic -->
<script>
    // --- 1. 資料定義 (Data Model) ---
    const quizData = {
        groupName: "題組 2：資安事件與防禦框架",
        questions: [
            {
                id: 15,
                type: "single",
                tag: "tag-mgm",
                tagName: "資安管理",
                color: "var(--tag-mgm)",
                question: "請問下列何項防禦改善措施跟本次事件的起因「<span class='negative-keyword'>較無直接關連</span>」？",
                options: [
                    { id: "A", text: "定期對員工進行教育訓練及案例說明，提升員工的資安意識，降低員工點擊釣魚信件的機率" },
                    { id: "B", text: "確保每一台端點都安裝防毒軟體與 EDR 軟體並且定期更新，提升端點設備對抗惡意程式的能力" },
                    { id: "C", text: "定期確認郵件閘道伺服器（Mail Gateway）阻擋釣魚信件的防護能力" },
                    { id: "D", text: "定期對公司官網做弱點掃描、源碼檢測、滲透測試" }
                ],
                correctAnswer: ["D"],
                reason: "官網弱點並非本次釣魚入侵的入口，因此關聯性最低。",
                detailedAnalysis: {
                    step1_keywords: ["點擊釣魚信件", "Mail Gateway 未攔截", "防毒軟體未更新", "事件起因"],
                    step2_translate: "公司是被釣魚信騙到，信件沒被擋、防毒又沒更新，才被入侵。現在要找的是：哪一個改善方向，跟「這次為什麼會發生」最沒有直接關係。",
                    step3_logic: {
                        steps: [
                            "畫出攻擊鏈（釣魚 → 點擊 → 端點失陷）",
                            "對照選項在防哪一段",
                            "找「完全不是防這條攻擊鏈」的"
                        ],
                        principle: "改善措施若對準入口，關聯度就高；防不同入口（例如官網漏洞）就屬於關聯低。",
                        example: "被詐騙電話騙錢，結果去裝防盜門，方向不對。"
                    },
                    step4_options: [
                        "(A) 防釣魚教育 → 直接對準入口 → 關聯高",
                        "(B) 端點防護更新 → 解決被控制 → 關聯高",
                        "(C) Mail Gateway 防護 → 阻止釣魚信 → 關聯高",
                        "(D) 官網弱點掃描 → 防網站漏洞，不是本次入口 → 關聯低"
                    ],
                    concept: "核心觀念定位：資安事件管理、社交工程防護。<br>定義：釣魚攻擊（Phishing）指誘騙使用者自行點擊或輸入資訊。",
                    analogy: "若事件是官網被 SQL Injection，哪個會最相關？答案就是弱點掃描。",
                    mnemonic: "信件點了炸，先顧人、信、電腦；官網掃描再重要，這題沒對到。",
                    trap: {
                        confusion: "搞混「全面資安」與「起因對焦」。",
                        blindspot: "看到弱點掃描就以為一定對，忽略了題目問的是「起因」。",
                        guide: "題目看到「起因」，先畫攻擊鏈。"
                    },
                    selfCheck: {
                        q: "若這次是官網被打，答案會換成哪一個？為什麼教育訓練在釣魚事件中這麼重要？",
                        a: "1. 若官網被打，(D) 關聯最高。<br>2. 因為釣魚是針對「人」的攻擊，技術攔截難以 100%，必須靠人來辨識。"
                    }
                }
            },
            {
                id: 16,
                type: "single",
                tag: "tag-iso",
                tagName: "防禦框架",
                color: "var(--tag-iso)",
                question: "關於 OWASP CDM（Cyber Defense Matrix）的描述，下列何項<span class='negative-keyword'>錯誤</span>？",
                options: [
                    { id: "A", text: "縱軸為設備、應用程式、網路、資料、人員" },
                    { id: "B", text: "橫軸為 Identify、Protect、Detect、Respond、Recover" },
                    { id: "C", text: "科技依賴由左至右越來越高，人員依賴由左至右越來越低" },
                    { id: "D", text: "CDM 主要用來分類防禦控制，非用來直接分析漏洞成因" }
                ],
                correctAnswer: ["C"],
                reason: "在 Respond 與 Recover 階段，其實非常仰賴「人員」的判斷與操作，而非依賴度降低。",
                detailedAnalysis: {
                    step1_keywords: ["OWASP CDM", "橫軸 / 縱軸", "依賴程度", "錯誤"],
                    step2_translate: "這題在問：哪一個對 CDM 的說法，其實是不合理或講錯的？",
                    step3_logic: {
                        steps: [
                            "確認橫軸是不是 NIST CSF",
                            "確認縱軸是不是資產類別",
                            "檢查「方向性敘述」是否合理"
                        ],
                        principle: "CDM 是盤點防禦，不是鑑識或根因分析。",
                        example: "表格是地圖，不是事故調查報告。"
                    },
                    step4_options: [
                        "(A) 符合五種資產 → 正確",
                        "(B) 符合 NIST CSF → 正確",
                        "(C) 把人員依賴一路說成下降，不符合回應與復原高度仰賴人 → 錯",
                        "(D) CDM 是分類工具 → 正確"
                    ],
                    concept: "CDM 常用來找「哪一格是空的」，不直接告訴你「為什麼會被打」。",
                    analogy: "CDM 就像是軍隊的兵力部署圖，讓你知道哪裡沒放人，但不能告訴你敵人怎麼打進來的。",
                    mnemonic: "橫軸五功能，縱軸五資產。",
                    trap: {
                        confusion: "誤以為科技越後面越強，人員就越不重要。",
                        blindspot: "以為所有框架都能做根因分析。",
                        guide: "回應與復原一定很靠人。"
                    },
                    selfCheck: {
                        q: "EDR 通常會落在哪些 CDM 格子？CDM 與 ATT&CK 的差異是什麼？",
                        a: "1. EDR 橫跨 Detect 與 Respond，針對 Device。<br>2. CDM 是防禦盤點（盾），ATT&CK 是攻擊行為（矛）。"
                    }
                }
            },
            {
                id: 17,
                type: "single",
                tag: "tag-iso",
                tagName: "防禦分類",
                color: "var(--tag-iso)",
                question: "下列何者描述是<span class='negative-keyword'>正確</span>的？",
                options: [
                    { id: "A", text: "資產盤點屬於 Identify" },
                    { id: "B", text: "限制開放 port 屬於 Detect" },
                    { id: "C", text: "詳細日誌屬於 Recover" },
                    { id: "D", text: "MFA 屬於 Respond" }
                ],
                correctAnswer: ["A"],
                reason: "資產盤點是「識別」我有什麼，屬於 Identify 階段。",
                detailedAnalysis: {
                    step1_keywords: ["Identify", "Protect", "Detect", "Respond", "Recover", "措施分類"],
                    step2_translate: "這題就是在考：這些資安措施，有沒有被放到正確的類別。",
                    step3_logic: {
                        steps: [
                            "Identify：知道有什麼",
                            "Protect：先把門鎖好",
                            "Detect：發現異常",
                            "Respond：出事處理",
                            "Recover：恢復營運"
                        ],
                        principle: "問自己「這是事前、事中、還是事後？」",
                        example: "無。"
                    },
                    step4_options: [
                        "(A) 盤點 → Identify → 正確",
                        "(B) 限制 port → Protect，不是 Detect",
                        "(C) 日誌 → Detect，不是 Recover",
                        "(D) MFA → Protect，不是 Respond"
                    ],
                    concept: "很愛考「日誌屬於哪一類」。",
                    analogy: "就像蓋房子：設計圖(I)、大門鎖(P)、監視器(D)、抓小偷(R)、修窗戶(Re)。",
                    mnemonic: "盤點 I，上鎖 P，看見 D，處理 R，復工 Re。",
                    trap: {
                        confusion: "把日誌放到 Recover。",
                        blindspot: "看到 MFA 就以為是事件發生後。",
                        guide: "MFA 永遠是事前 (Protect)。"
                    },
                    selfCheck: {
                        q: "SIEM 告警屬於哪一類？備份還原屬於哪一類？",
                        a: "1. SIEM 告警屬於 Detect (偵測)。<br>2. 備份還原屬於 Recover (復原)。"
                    }
                }
            },
            {
                id: 18,
                type: "multi",
                tag: "tag-sec",
                tagName: "攻擊技術",
                color: "var(--tag-sec)",
                question: "（複選）關於 MITRE ATT&CK Initial Access，下列哪些<span class='negative-keyword'>錯誤</span>？",
                options: [
                    { id: "A", text: "做好修補就不可能被 Exploit Public-Facing Application" },
                    { id: "B", text: "可透過搜尋引擎或 GitHub 找到 Valid Accounts" },
                    { id: "C", text: "供應鏈攻擊來源廣泛，需妥善管理" },
                    { id: "D", text: "Phishing 只存在於 Email" }
                ],
                correctAnswer: ["A", "D"],
                reason: "資安沒有 100% 的防禦（有 0-day）；釣魚也不僅限於 Email（還有簡訊、語音等）。",
                detailedAnalysis: {
                    step1_keywords: ["Initial Access", "不可能 / 只", "Phishing", "Valid Accounts"],
                    step2_translate: "這題在找「講太滿」或「定義講錯」的敘述。",
                    step3_logic: {
                        steps: [
                            "看到「不可能」「只有」先懷疑",
                            "檢查是否符合實務與 ATT&CK 定義"
                        ],
                        principle: "資安永遠沒有 100%，有 0-day 漏洞。",
                        example: "門鎖得再好，窗戶也可能被打破。"
                    },
                    step4_options: [
                        "(A) 有 0-day，不可能是錯的",
                        "(B) 實務常見 → 正確",
                        "(C) 供應鏈風險確實存在 → 正確",
                        "(D) 釣魚不只 Email → 錯"
                    ],
                    concept: "Initial Access 是「第一個破口」；不保證型框架，不談 100%。",
                    analogy: "釣魚不只信件，還有電話 (Vishing)、簡訊 (Smishing)。",
                    mnemonic: "不可能、只有，多半錯。",
                    trap: {
                        confusion: "把釣魚只想成 Email。",
                        blindspot: "過度相信工具。",
                        guide: "資安永遠沒有 100%。"
                    },
                    selfCheck: {
                        q: "請舉兩種非 Email 的釣魚方式？MFA 能不能完全避免 Valid Accounts 入侵？",
                        a: "1. 簡訊詐騙 (Smishing)、電話詐騙 (Vishing)。<br>2. 不能，因為 MFA 也可能被繞過 (MFA Fatigue, Phishing) 或 Token 被竊取。"
                    }
                }
            }
        ]
    };

    // --- 2. 狀態管理 (State Management) ---
    let quizState = {
        completedCount: 0,
        results: {} // key: questionId, value: { status: 'correct'/'wrong', userAnswer: [] }
    };

    // --- 3. 初始化與渲染 (Init & Render) ---
    document.addEventListener('DOMContentLoaded', () => {
        initQuiz();
    });

    function initQuiz() {
        renderTabs();
        renderQuestions();
        updateProgress();
    }

    // 洗牌演算法 (Fisher-Yates)
    function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
    }

    function renderTabs() {
        const tabContainer = document.getElementById('quizTabs');
        tabContainer.innerHTML = quizData.questions.map((q, index) => `
            <li class="nav-item" role="presentation">
                <button class="nav-link ${index === 0 ? 'active' : ''}" 
                        id="tab-${q.id}" 
                        data-bs-toggle="tab" 
                        data-bs-target="#content-${q.id}" 
                        type="button" 
                        role="tab"
                        onclick="scrollToTop()">
                    第 ${q.id} 題
                    <i class="fas fa-circle tab-status-icon" id="icon-${q.id}" style="color: #e9ecef;"></i>
                </button>
            </li>
        `).join('');
    }

    function renderQuestions() {
        const contentContainer = document.getElementById('quizTabContent');
        
        contentContainer.innerHTML = quizData.questions.map((q, index) => {
            // 選項隨機排序 (內容亂，但代號會重整)
            let displayOptions = [...q.options];
            shuffleArray(displayOptions); // 啟用隨機

            const badgeType = q.type === 'multi' ? '複選題' : '單選題';

            return `
            <div class="tab-pane fade ${index === 0 ? 'show active' : ''}" id="content-${q.id}" role="tabpanel">
                
                <!-- 題目標籤 -->
                <div class="mb-3">
                    <span class="tag-badge" style="background-color: ${q.color}">${q.tagName}</span>
                    <span class="badge bg-secondary">${badgeType}</span>
                </div>

                <!-- 題目內容 -->
                <div class="question-text">
                    ${q.question}
                </div>

                <!-- 選項區域 -->
                <div class="options-container" id="options-container-${q.id}">
                    ${displayOptions.map((opt, i) => {
                        // 動態生成顯示代號 (A, B, C, D...)，確保視覺順序永遠固定
                        const visualLabel = String.fromCharCode(65 + i); 
                        
                        return `
                        <div class="option-card" 
                             onclick="selectOption(${q.id}, '${opt.id}', '${q.type}')"
                             id="opt-${q.id}-${opt.id}"
                             data-opt-id="${opt.id}">
                            <div class="option-indicator">${visualLabel}</div>
                            <div class="option-text">${opt.text}</div>
                        </div>
                    `}).join('')}
                </div>

                <!-- 操作按鈕 -->
                <div class="action-area">
                    <button class="btn btn-submit" id="btn-submit-${q.id}" onclick="submitAnswer(${q.id})">
                        送出答案
                    </button>
                    <button class="btn btn-retry" id="btn-retry-${q.id}" onclick="retryQuestion(${q.id})">
                        <i class="fas fa-redo me-2"></i>重新挑戰
                    </button>
                </div>

                <!-- 回饋區 -->
                <div class="feedback-area" id="feedback-${q.id}">
                    <h5 class="fw-bold mb-2" id="feedback-title-${q.id}"></h5>
                    <p class="mb-0" id="feedback-text-${q.id}"></p>
                </div>

                <!-- 深度解析 (九大步驟) -->
                <div class="explain-container" id="explain-${q.id}">
                    <h4 class="mb-4 text-center" style="color: var(--primary-color); font-weight:700;">
                        <i class="fas fa-book-reader me-2"></i>全方位解題分析
                    </h4>

                    <!-- 1. 找關鍵字 -->
                    <div class="analysis-step">
                        <div class="analysis-title"><i class="fas fa-search"></i>第一步：找關鍵字</div>
                        <div class="analysis-content keyword-box">
                            ${q.detailedAnalysis.step1_keywords.map(k => `<span>${k}</span>`).join('')}
                        </div>
                    </div>

                    <!-- 2. 白話翻譯 -->
                    <div class="analysis-step">
                        <div class="analysis-title"><i class="fas fa-language"></i>第二步：白話翻譯</div>
                        <div class="analysis-content translate-box">
                            ${q.detailedAnalysis.step2_translate}
                        </div>
                    </div>

                    <!-- 3. 解題思路 -->
                    <div class="analysis-step">
                        <div class="analysis-title"><i class="fas fa-brain"></i>第三步：解題思路</div>
                        <div class="analysis-content">
                            <div class="mb-2"><strong>解題步驟：</strong></div>
                            ${q.detailedAnalysis.step3_logic.steps.map(s => `<div class="logic-step">${s}</div>`).join('')}
                            <div class="mt-3"><strong>原理與規則：</strong><br>${q.detailedAnalysis.step3_logic.principle}</div>
                            ${q.detailedAnalysis.step3_logic.example ? `<div class="logic-example"><i class="fas fa-carrot me-1"></i><strong>生活例子：</strong>${q.detailedAnalysis.step3_logic.example}</div>` : ''}
                        </div>
                    </div>

                    <!-- 4. 選項分析 -->
                    <div class="analysis-step">
                        <div class="analysis-title"><i class="fas fa-list-ul"></i>第四步：選項分析</div>
                        <div class="analysis-content">
                            <ul class="list-unstyled">
                                ${q.detailedAnalysis.step4_options.map(o => `<li class="mb-2"><i class="fas fa-check-square me-2 text-muted"></i>${o}</li>`).join('')}
                            </ul>
                        </div>
                    </div>

                    <!-- 5. 觀念補充 -->
                    <div class="analysis-step">
                        <div class="analysis-title"><i class="fas fa-graduation-cap"></i>觀念補充與延伸</div>
                        <div class="analysis-content">
                            ${q.detailedAnalysis.concept}
                        </div>
                    </div>

                    <!-- 6. 觸類旁通 -->
                    <div class="analysis-step">
                        <div class="analysis-title"><i class="fas fa-exchange-alt"></i>觸類旁通（舉一反三）</div>
                        <div class="analysis-content">
                            ${q.detailedAnalysis.analogy}
                        </div>
                    </div>

                    <!-- 7. 記憶口訣 -->
                    <div class="analysis-step">
                        <div class="golden-box">
                            <i class="fas fa-star me-2"></i>${q.detailedAnalysis.mnemonic}
                        </div>
                    </div>

                    <!-- 8. 常見陷阱 -->
                    <div class="analysis-step">
                        <div class="analysis-title" style="color:#c62828;"><i class="fas fa-exclamation-triangle" style="color:#c62828;"></i>常見陷阱 & 避坑指南</div>
                        <div class="analysis-content trap-box">
                            <div class="trap-item"><span class="trap-label">陷阱：</span>${q.detailedAnalysis.trap.confusion}</div>
                            <div class="trap-item"><span class="trap-label">盲點：</span>${q.detailedAnalysis.trap.blindspot}</div>
                            <div class="trap-item"><span class="trap-label">避坑：</span>${q.detailedAnalysis.trap.guide}</div>
                        </div>
                    </div>

                    <!-- 9. 自我檢測 -->
                    <details class="self-check">
                        <summary>
                            <span><i class="fas fa-clipboard-check me-2 text-success"></i>自我檢測：${q.detailedAnalysis.selfCheck.q}</span>
                        </summary>
                        <div class="self-check-content">
                            <p class="text-success mb-0 fw-bold">解答：</p>
                            <p class="mb-0">${q.detailedAnalysis.selfCheck.a}</p>
                        </div>
                    </details>
                </div>
            </div>
            `;
        }).join('');
    }

    // --- 4. 互動邏輯 (Interaction Logic) ---
    let currentSelections = {};

    function selectOption(qId, optId, type) {
        if (quizState.results[qId]) return;

        if (!currentSelections[qId]) currentSelections[qId] = [];

        if (type === 'single') {
            currentSelections[qId] = [optId];
            document.querySelectorAll(`#options-container-${qId} .option-card`).forEach(el => {
                el.classList.remove('selected');
            });
            document.getElementById(`opt-${qId}-${optId}`).classList.add('selected');
        } else {
            const index = currentSelections[qId].indexOf(optId);
            const el = document.getElementById(`opt-${qId}-${optId}`);
            
            if (index > -1) {
                currentSelections[qId].splice(index, 1);
                el.classList.remove('selected');
            } else {
                currentSelections[qId].push(optId);
                el.classList.add('selected');
            }
        }
    }

    function submitAnswer(qId) {
        const userAns = currentSelections[qId];
        if (!userAns || userAns.length === 0) {
            alert("請先選擇一個答案！");
            return;
        }

        const question = quizData.questions.find(q => q.id === qId);
        const sortedUser = [...userAns].sort();
        const sortedCorrect = [...question.correctAnswer].sort();
        const isCorrect = JSON.stringify(sortedUser) === JSON.stringify(sortedCorrect);

        quizState.results[qId] = { status: isCorrect ? 'correct' : 'wrong', userAnswer: userAns };

        // 轉換邏輯代號 (Logical ID) 為目前顯示的視覺代號 (Visual Label)
        // 例如：原本正確答案是 "A"，但現在顯示在第三個位置，視覺代號就是 "C"
        const correctVisualLabels = question.correctAnswer.map(logicId => {
            // 從 DOM 查找該選項目前顯示的代號
            const el = document.querySelector(`#options-container-${qId} .option-card[data-opt-id="${logicId}"] .option-indicator`);
            return el ? el.innerText : logicId; // 如果找不到則回退到原始 ID
        }).sort();

        const options = document.querySelectorAll(`#options-container-${qId} .option-card`);
        options.forEach(opt => {
            opt.classList.add('disabled');
            const optId = opt.getAttribute('data-opt-id');
            if (question.correctAnswer.includes(optId)) {
                opt.classList.add('correct-answer');
            } else if (userAns.includes(optId) && !question.correctAnswer.includes(optId)) {
                opt.classList.add('wrong-answer');
            }
        });

        const feedbackArea = document.getElementById(`feedback-${qId}`);
        const feedbackTitle = document.getElementById(`feedback-title-${qId}`);
        const feedbackText = document.getElementById(`feedback-text-${qId}`);
        
        feedbackArea.style.display = 'block';
        feedbackArea.className = `feedback-area ${isCorrect ? 'feedback-success' : 'feedback-error'}`;
        
        // 顯示回饋時，使用正確的「視覺代號」
        if (isCorrect) {
            feedbackTitle.innerHTML = '<i class="fas fa-check-circle me-2"></i>答對了！';
            feedbackText.innerHTML = question.reason;
        } else {
            feedbackTitle.innerHTML = '<i class="fas fa-times-circle me-2"></i>答錯了...';
            // 這裡顯示轉換後的 correctVisualLabels
            feedbackText.innerHTML = `正確答案是 <strong>${correctVisualLabels.join('、')}</strong>。<br>${question.reason}`;
        }

        document.getElementById(`explain-${qId}`).style.display = 'block';
        document.getElementById(`btn-submit-${qId}`).style.display = 'none';
        document.getElementById(`btn-retry-${qId}`).style.display = 'inline-block';

        const tabIcon = document.getElementById(`icon-${qId}`);
        tabIcon.className = `fas fa-circle tab-status-icon ${isCorrect ? 'status-correct' : 'status-wrong'}`;
        tabIcon.classList.remove('fa-circle');
        tabIcon.classList.add(isCorrect ? 'fa-check-circle' : 'fa-times-circle');

        updateProgress();
        feedbackArea.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }

    function retryQuestion(qId) {
        delete quizState.results[qId];
        delete currentSelections[qId];

        const options = document.querySelectorAll(`#options-container-${qId} .option-card`);
        options.forEach(opt => {
            opt.classList.remove('selected', 'correct-answer', 'wrong-answer', 'disabled');
        });

        document.getElementById(`feedback-${qId}`).style.display = 'none';
        document.getElementById(`explain-${qId}`).style.display = 'none';
        document.getElementById(`btn-submit-${qId}`).style.display = 'inline-block';
        document.getElementById(`btn-retry-${qId}`).style.display = 'none';

        const tabIcon = document.getElementById(`icon-${qId}`);
        tabIcon.className = 'fas fa-circle tab-status-icon';
        tabIcon.style.color = '#e9ecef';

        updateProgress();
        document.querySelector(`#content-${qId}`).scrollIntoView({ behavior: 'smooth' });
    }

    function updateProgress() {
        const total = quizData.questions.length;
        const completed = Object.keys(quizState.results).length;
        const percentage = (completed / total) * 100;
        document.getElementById('progressBar').style.width = `${percentage}%`;
        
        const badge = document.getElementById('progressText');
        badge.innerText = `已完成 ${completed}/${total}`;
        if (completed === total) {
            badge.className = 'badge bg-success';
            badge.innerText = '全數完成';
        } else {
            badge.className = 'badge bg-secondary';
        }
    }

    function scrollToTop() {
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    window.onerror = function() {
        if (!window.bootstrap) {
            console.warn("Bootstrap CDN failed.");
            document.body.style.fontFamily = "sans-serif";
        }
    };
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js" xintegrity="sha384-geWF76RCwLtnZ8qwWowPQNguL3RmwHVBC9FhGdlKrxdiJJigb/j/68SIy3Te4Bkz" crossorigin="anonymous"></script>

</body>
</html>